# Discrete Molecular Dynamics Data Analysis Toolkit
## Introduction
This GitHub repository contains utility programs for analyzing simulation data generated by Discrete Molecular Dynamics (DMD), a molecular dynamics algorithm with significantly improved computational efficiency and proven accuracy in a wide range of applications, and the Medusa software package. Both DMD and Medusa are available upon request for academic use or through [Molecules in Action, LLC](https://www.moleculesinaction.com/pdmd.html) for commercial or other purposes.
The utility programs in this repository are designed to analyze large simulation datasets generated in DMD simulations. All the inputs and outputs of the exmaples shown below are provided in this repostory.

## Dependencies
* Python (version 3.7 or later) is recommended. The needed libraries:
  * Matplotlib (https://matplotlib.org)
  * Numpy (https://numpy.org)
* Awk (https://github.com/onetrueawk/awk)

## Two-dimensional potential of mean force (2D-PMF) analysis
Potential of mean force is the effective free energy derived from probability distributions of computational simulations. The basins on 2D-PMF in replica-exchange simulations corresponds to the highly populated intermediate states, while the ridges/peaks correspond to the sparsely populated transitional states ([see details](https://www.chem.ucla.edu/~harding/IGOC/I/intermediate.html)). The conformations of these states provide mechanistic insights into the pathway of chemical and biological processes.

### Visualization

[*pmf_plot.ipynb*](https://github.com/GANGTONGH/Discrete-Molecular-Dynamics-Data-Analysis-Toolkit/blob/main/Potential%20of%20Mean%20Force/pmf_plot.ipynb) visualizes 2D-PMF in the style of a contour plot with a rainbow color scheme.

Output:

<div align="center">
 <img src="https://github.com/GANGTONGH/Discrete-Molecular-Dynamics-Data-Analysis-Toolkit/blob/main/Potential%20of%20Mean%20Force/pmf.png" width="400">
</div>

### Extract representative structures of replica-exchange simulations according to 2D-PMF

[*rep-str.sh*](https://github.com/GANGTONGH/Discrete-Molecular-Dynamics-Data-Analysis-Toolkit/blob/main/Representative%20Structure/rep-str.sh) can extract the conformations corresponding to a given region on 2D-PMF, for example, the box α on the 2D-PMF shown below:

<div align="center">
 <img src="https://github.com/GANGTONGH/Discrete-Molecular-Dynamics-Data-Analysis-Toolkit/blob/main/Representative%20Structure/pmf-rep-str.png" width="400">
</div>

The region can be defined by its centroid (0.05, 14), and the half-width along the x and y directions: 0.05 and 1, respectively.

The usage of rep-str.sh:
```
./rep-str.sh center_x tolerance_x center_y tolerance_y sampling_interval in_pdb output_commands
```
* center_x: the x-coordinate of the centroid
* tolerance_x: the tolerance or half-width of the box defining the 2D-PMF region of interest
* sampling_interval: the algorithm will search the simulation trajectory every *sampling_interval* steps for the conformations that fall into the box
* in_pdb: the path to the input pdb of the DMD simulation
* output_commands:
  * 0 - output the (1) time range, (2) replica index, (3) time step, (4) padded replica index into a column file.
  * 1 - output [Medusa](https://www.moleculesinaction.com/services.html) commands that extracts the corresponding structures.

In the example above, the code for showing where the conformations the fall into box α are located in the simulation trajectories would be:
```
./rep-str.sh 0.05 0.05 14 1 100 input.pdb 0
```

## Secondary structure contents
[*ssCont.awk*](https://github.com/GANGTONGH/Discrete-Molecular-Dynamics-Data-Analysis-Toolkit/blob/main/Secondary%20structure%20content/ssCont.awk) can rapidly calculate the contents of the average secondary structures of the entire protein system in a DMD trajectory.
This script takes the standard DSSP output from DMD as the input file.
Usage:
```bash
awk -f ssCont.awk in_dssp.example > out_sscont.dat
```
The columns from left to right contains the contents of the secondary structure types, respectively:
* ɑ-helix
* Isolated β-bridge
* β-sheet
* 3<sub>10</sub> helix
* π-helix
* β-turn
* Bend
* Random coil

If you need more detailed information of a specific peptide chain, [*ssResCont.py*](https://github.com/GANGTONGH/Discrete-Molecular-Dynamics-Data-Analysis-Toolkit/blob/main/Secondary%20structure%20content/ssResCont.py) will calculate the secondary structure propensity of each residue.

Usage:
```python
python ssResCont.py -i in_dssp.example -o out_ssrescont.dat
```
Similarly, the columns from left to right contains the contents of the secondary structure types as described above. Rows from top to bottom corresponds to the amino acid residues in the system as ordered in the starting PDB structure of the simulation.

## Fibrillar aggregate morphology analysis
We can differentiated protein aggregates according to their respective morphologies. The parameters that characterize the morphology are: (1) number of layers and (2) the size of each layer. 
The two types of fibrillar aggregates are: 
* Amyloids: have a small number of β-sheet layers (typically close to 2). [Example](https://www.science.org/doi/10.1126/science.aao2825#F1)
* Nanocrystals: have a large number of layers. [Example](https://www.science.org/doi/10.1126/science.aal5005#F2)

In a given  system, the total number of peptide chains is constant. Therefore, a nanocrystal conformation will have more layers but small-sized β-sheets, while a fibril will have fewer layers but large-sized β-sheets. For an aggregation process, the largest aggregate has the most significance.
[*bsh-layers-cutoff.py*](https://github.com/GANGTONGH/Discrete-Molecular-Dynamics-Data-Analysis-Toolkit/blob/main/Fibrillar%20structure%20analysis/bsh-layers-cutoff.py) can calculate (1) the number of β-sheets layers and (2) the average size of the β-sheets in each layer in the largest aggregate for each trajectory frame.

The advantages of this program include: (1) only considered the clusters with β-sheet contents, (2) give option to exclude small aggregates. These two features effectively eliminate the noise from disordered, non-fibrillar aggregates.
Usage:
```python
python bsh-layers-cutoff.py -dssp dssp.example -bshClust bshClust.example -o bsh-layers-cutoff4.dat -c 4 -v "[1,4,7,10,13,16,19,22,25,28,31,34,37,40,43,46,49,52,55,58]"
```
The first column is the number of β-sheet layers, and the second column is the average size of the layers.
The example output:
```
2.798449612403101 6.7894736842105265
2.798449612403101 6.7894736842105265
2.798449612403101 6.7894736842105265
......            ......
```
characterizes a structure resembling an amyloid:
<div align="center">
<img src="https://github.com/GANGTONGH/Discrete-Molecular-Dynamics-Data-Analysis-Toolkit/blob/13816a0681ddec190048581871fe5648050d317d/Fibrillar%20structure%20analysis/example.png" width="200">
</div>

## Q-value analysis
Q-value is a generalization of *Q* (the fraction of native contacts), an order parameter in protein folding. Q-value can be used to assess the amyloid fibril forming propensity of a peptide chain or individual amino acid residues (*Q<sub>chain</sub>* and *Q<sub>residue</sub>*, respectively). 

The advantages of this metric include: (1) straightforward and highly interpretable, (2) compared with β-sheet content, which is commonly utilized to evaluate fibrillization, Q-value distinguishes parallel in-register β-sheets from mismatched β-sheets, thus filtering out the off-pathway intermediates and highlighting the unique characteristic of amyloid fibrils.

<div align="center">
 <img src="https://github.com/GANGTONGH/Discrete-Molecular-Dynamics-Data-Analysis-Toolkit/blob/main/Q-value-analysis/Q-value.png" width="600">
</div>

*Figure adapted from: https://doi.org/10.1021/acs.jcim.3c00898*

Q-value is calculated using the following formulas:

$`
Q_{chain} = N_{in\ register}/N_{total}
`$, where *N<sub>in register</sub>* is the number of amino acid residues forming parallel in-register contacts,and *N<sub>total</sub>* is the total numbers of residues.

and

$`
Q_{residue} = C_{in\ register}/C_{total}
`$, where *C<sub>in register</sub>* is the number of in-register contacts formed by the amino acid in question, and *C<sub>total</sub>* is the total number of contacts formed by this amino acid residue.

If you find this method useful, please consider referencing the following papers.

\[1\] https://doi.org/10.1021/acs.jcim.4c01471

\[2\] https://doi.org/10.1021/acs.jcim.3c00898


<!--
## Data visualization

## 2-dimensional PMF visualization
--->

## Protein structure visualization
For structure visualization, [PyMOL](https://www.pymol.org/) is required.
### Coloring
The following tools and commands generate an easy-to-read heat map with custom parameter, where the value of the parameter is mapped onto the protein surface. Each residue is colored according to the parameter value from maximum (red) to minimum (blue): 
<div align="center">
 <img src="https://github.com/GANGTONGH/Discrete-Molecular-Dynamics-Data-Analysis-Toolkit/blob/224960143076c3c6232b4c74bf5c56838489fc69/Protein%20structure%20coloring/colorbar.png" width="200">
</div>

In this example, we will map the affinity of each amino acid in the Bri2 BRICHOS protein with a small molecule onto the 3D protein structure (PDB). 

[*color.sh*](https://github.com/GANGTONGH/Discrete-Molecular-Dynamics-Data-Analysis-Toolkit/blob/main/Protein%20structure%20coloring/color.sh) adds the color information into the PDB file.
The following inputs are required:
* *brichos_template.pdb*: the protein structure to be colored
* *contact_prob_per_residue.dat*: the corredponding value of the parameter on each residue, arranged into a single column.

Usage:
```bash
./color.sh brichos_template.pdb contact_prob_per_residue.dat graph.pdb *residue_index_offset
```
*residue_index_offset: the index shift when the residue index of the PDB does not start with 1. For example, if the starting index is 10, then residue_index_offset should be set as 9.

This step generates the colored structure, *graph.pdb*.
Then, load *graph.pdb* into PyMOL. To show the color, run the following command in the PyMOL console:
```python
spectrum b, rainbow, minimum = 0, maximum = 1
```
The parts of Bri2 BRICHOS with a higher affinity is closer to red (warmer), the parts with lower affinity is closer to blue (colder).

<div align="center">
 <img src="https://github.com/GANGTONGH/Discrete-Molecular-Dynamics-Data-Analysis-Toolkit/blob/58b7ffac3cca0d53da34547cb60dafa194e09251/Protein%20structure%20coloring/colored_protein.png" width="250">
</div>

<!---
## Extract representative snapshots from replica-exchange simulations
--->


